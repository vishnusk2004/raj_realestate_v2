{% load static %}
{% load price_filters %}
{% load humanize %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ community.name }} - {{ brand_name }}</title>
    <meta name="description" content="Explore properties in {{ community.name }}. {{ community.description|truncatewords:20 }}">
    <link rel="icon" type="image/png" href="{% static 'favicon.png' %}">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/django-main.css' %}">
    <style>
        /* Prevent layout shift - reserve space for images */
        img[loading="lazy"] {
            background-color: #f3f4f6;
            min-height: 200px;
        }
        
        /* Ensure page structure loads first */
        img {
            content-visibility: auto;
        }
        
        /* Image loading placeholder */
        img[loading="lazy"]::before {
            content: '';
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Prevent video download */
        video::-webkit-media-controls-enclosure {
            overflow: hidden;
        }
        video::-webkit-media-controls-panel {
            width: calc(100% + 32px);
        }
        /* Hide download button in video controls */
        video::-internal-media-controls-download-button {
            display: none !important;
        }
        video::-webkit-media-controls-download-button {
            display: none !important;
        }
        /* Prevent text selection on video */
        #modalVideoSrc {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body>
    {% include 'Raj/social_media_sidebar.html' %}
    {% include 'Raj/navbar.html' %}

    <main class="flex-1">
        <div class="min-h-screen bg-surface-gradient">
            <!-- Community Header -->
            <section class="relative py-24 bg-gradient-to-br from-primary/10 to-accent/10">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="grid lg:grid-cols-2 gap-12 items-center">
                        <div>
                            <div class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 hover:bg-primary/80 mb-4 bg-accent/10 text-accent-foreground border-accent/20">Featured Community</div>
                            <h1 class="font-display text-4xl md:text-5xl font-bold text-foreground mb-6">{{ community.name }}</h1>
                            {% if community.description %}
                            <p class="text-lg text-muted-foreground leading-relaxed mb-8">{{ community.description }}</p>
                            {% endif %}
                        </div>
                        <div class="relative">
                            {% if community.get_image_url %}
                                <img src="{{ community.get_image_url }}" alt="{{ community.name }}" class="rounded-2xl shadow-xl w-full h-auto object-cover" loading="lazy" decoding="async">
                            {% else %}
                                <div class="w-full h-64 bg-gradient-to-br from-accent/20 to-accent/10 rounded-2xl flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin w-24 h-24 text-accent/50">
                                        <path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </section>

            <!-- Filters and Properties -->
            <section class="py-16">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <!-- Filters -->
                    {% comment %}
                    <div class="mb-8">
                        <form method="GET" class="grid md:grid-cols-4 gap-4">
                            <div>
                                <label class="text-sm font-medium mb-2 block">Property Type</label>
                                <select name="property_type" class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                                    <option value="">All Types</option>
                                    <option value="buy" {% if property_type_filter == 'buy' %}selected{% endif %}>For Sale</option>
                                    <option value="lease" {% if property_type_filter == 'lease' %}selected{% endif %}>For Lease</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium mb-2 block">Status</label>
                                <select name="property_status" class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                                    <option value="">All Status</option>
                                    <option value="coming_soon" {% if property_status_filter == 'coming_soon' %}selected{% endif %}>Coming Soon</option>
                                    <option value="just_listed" {% if property_status_filter == 'just_listed' %}selected{% endif %}>Just Listed</option>
                                    <option value="for_sale" {% if property_status_filter == 'for_sale' %}selected{% endif %}>For Sale</option>
                                    <option value="for_lease" {% if property_status_filter == 'for_lease' %}selected{% endif %}>For Lease</option>
                                    <option value="under_contract" {% if property_status_filter == 'under_contract' %}selected{% endif %}>Under Contract</option>
                                    <option value="just_sold" {% if property_status_filter == 'just_sold' %}selected{% endif %}>Just Sold</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium mb-2 block">Search</label>
                                <input type="text" name="search" value="{{ search_query }}" placeholder="Search properties..." class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                            </div>
                            <div class="flex items-end">
                                <button type="submit" class="w-full inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                                    Filter
                                </button>
                            </div>
                        </form>
                    </div>
                    {% endcomment %}

                    <!-- Properties Grid -->
                    {% if properties %}
                    <div class="text-center mb-12">
                        <h2 class="text-3xl md:text-4xl font-bold text-foreground mb-4">Properties in {{ community.name }}</h2>
                        <p class="text-muted-foreground text-lg max-w-2xl mx-auto">Browse our available properties and successful transactions in {{ community.name }}. Your dream property could be next!</p>
                    </div>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-16">
                        {% for property in properties %}
                        <div class="rounded-lg border bg-card text-card-foreground shadow-sm group overflow-hidden shadow-soft hover:shadow-medium transition-all duration-300 animate-fade-in" data-property-id="{{ property.id }}">
                            <div class="relative overflow-hidden">
                                {% if property.get_main_image_url %}
                                    <img src="{{ property.get_main_image_url }}" alt="{{ property.title }}" class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300" loading="lazy" decoding="async">
                                {% else %}
                                    <div class="w-full h-48 bg-muted flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home h-12 w-12 text-muted-foreground">
                                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                            <polyline points="9,22 9,12 15,12 15,22"></polyline>
                                        </svg>
                                    </div>
                                {% endif %}
                                <div class="absolute top-4 left-4 flex gap-2 flex-wrap">
                                    <div class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-primary text-primary-foreground">
                                        {{ property.get_property_status_display }}
                                    </div>
                                </div>
                            </div>
                            <div class="p-6 space-y-4">
                                <div>
                                    <h3 class="text-lg font-semibold text-foreground mb-2 line-clamp-1">{{ property.title }}</h3>
                                    <div class="flex items-center text-muted-foreground mb-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin h-4 w-4 mr-1">
                                            <path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"></path>
                                            <circle cx="12" cy="10" r="3"></circle>
                                        </svg>
                                        <span class="text-sm">{{ property.location }}</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between text-sm text-muted-foreground">
                                    <div class="flex items-center space-x-4">
                                        {% if property.bedrooms %}
                                        <div class="flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bed h-4 w-4 mr-1">
                                                <path d="M2 4v16"></path>
                                                <path d="M2 8h18a2 2 0 0 1 2 2v10"></path>
                                                <path d="M2 17h20"></path>
                                                <path d="M6 8v9"></path>
                                            </svg>
                                            <span>{{ property.bedrooms }}</span>
                                        </div>
                                        {% endif %}
                                        {% if property.bathrooms %}
                                        <div class="flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bath h-4 w-4 mr-1">
                                                <path d="M10 4 8 6"></path>
                                                <path d="M17 19v2"></path>
                                                <path d="M2 12h20"></path>
                                                <path d="M7 19v2"></path>
                                                <path d="M9 5 7.621 3.621A2.121 2.121 0 0 0 4 5v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5"></path>
                                            </svg>
                                            <span>{{ property.bathrooms }}</span>
                                        </div>
                                        {% endif %}
                                        {% if property.area_sqft %}
                                        <div class="flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square h-4 w-4 mr-1">
                                                <rect width="18" height="18" x="3" y="3" rx="2"></rect>
                                            </svg>
                                            <span>{{ property.area_sqft|floatformat:0 }}</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex items-center justify-between pt-4 border-t">
                                    {% if property.property_status != 'just_sold' and property.property_status != 'for_lease' %}
                                    <div class="text-2xl font-bold text-primary">
                                        {% if property.property_type == 'lease' %}
                                            {{ property.price }}{% if property.price and not property.price|slice:":1" == "$" %}/month{% endif %}
                                        {% else %}
                                            {{ property.price }}
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    <button type="button"
                                        class="view-details inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 border bg-background h-10 px-4 py-2 border-primary text-primary hover:bg-primary hover:text-primary-foreground"
                                        data-id="{{ property.id }}"
                                        data-title="{{ property.title|escapejs }}"
                                        data-location="{{ property.location|escapejs }}"
                                        data-price="{{ property.price }}"
                                        data-type="{{ property.property_type }}"
                                        data-bedrooms="{{ property.bedrooms|default_if_none:'' }}"
                                        data-bathrooms="{{ property.bathrooms|default_if_none:'' }}"
                                        data-area="{{ property.area_sqft|default_if_none:'' }}"
                                        data-description="{{ property.description|default:''|escapejs }}"
                                        data-images="{{ property.get_all_image_urls|join:'|||' }}"
                                        data-main-image="{{ property.get_main_image_url|default:'' }}"
                                        data-media='{{ property.get_all_media_urls|to_json }}'
                                        data-status="{{ property.property_status }}"
                                        data-agent-name="{{ property.listing_agent_name|default:''|escapejs }}"
                                        data-agent-image="{{ property.get_listing_agent_image_url|default:'' }}"
                                        data-contact-email="{{ property.contact_email }}"
                                        data-contact-phone="{{ property.contact_phone }}">
                                        View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </section>
        </div>
    </main>

    {% include 'Raj/footer.html' %}

<!-- Property Details Modal -->
    <div id="propertyModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div role="dialog" aria-describedby="modal-description" aria-labelledby="modal-title" data-state="open" class="fixed left-[50%] top-[50%] z-50 grid w-full translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg max-w-4xl max-h-[90vh] overflow-y-auto" tabindex="-1" style="pointer-events: auto;">
            <div class="flex flex-col space-y-1.5 text-center sm:text-left">
                <h2 id="modal-title" class="tracking-tight text-2xl font-bold">Property Details</h2>
                </div>
            <div class="space-y-6">
                <div id="modalMedia" class="relative">
                    <div id="mediaCarousel" class="relative overflow-hidden rounded-lg flex items-center justify-center bg-gray-100" style="min-height: 16rem; max-height: 24rem; width: 100%; display: flex; align-items: center; justify-content: center;">
                        <img id="modalImageSrc" src="" alt="Property Image" class="w-full max-h-[24rem] object-contain transition-opacity duration-300 hidden" loading="lazy" decoding="async">
                        <video id="modalVideoSrc" controls controlsList="nodownload noplaybackrate" disablePictureInPicture oncontextmenu="return false;" onselectstart="return false;" ondragstart="return false;" preload="none" class="w-full h-full max-h-[24rem] object-contain transition-opacity duration-300 hidden" style="aspect-ratio: auto; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">
                            Your browser does not support the video tag.
                        </video>
                        </div>
                    <div id="imageNavigation" class="hidden">
                        <button id="prevImage" class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-black text-white p-4 rounded-full hover:bg-gray-800 transition-all shadow-2xl border-2 border-white">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <button id="nextImage" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-black text-white p-4 rounded-full hover:bg-gray-800 transition-all shadow-2xl border-2 border-white">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                        <div id="imageDots" class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2">
                            <!-- Dots will be generated by JavaScript -->
                        </div>
                            </div>
                        </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Property Details</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-muted-foreground">Price:</span>
                                <span id="modalPrice" class="font-semibold text-primary">-</span>
                    </div>
                            <div class="flex justify-between">
                                <span class="text-muted-foreground">Location:</span>
                                <span id="modalLocation">-</span>
                        </div>
                            <div class="flex justify-between">
                                <span class="text-muted-foreground">Status:</span>
                                <span id="modalStatus">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-muted-foreground">Bedrooms:</span>
                                <span id="modalBedrooms">-</span>
                    </div>
                            <div class="flex justify-between">
                                <span class="text-muted-foreground">Bathrooms:</span>
                                <span id="modalBathrooms">-</span>
                </div>
                            <div class="flex justify-between">
                                <span class="text-muted-foreground">Square Feet:</span>
                                <span id="modalArea">-</span>
                    </div>
                </div>
                            </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Features</h3>
                        <div id="modalFeatures" class="flex flex-wrap gap-2">
                            <span class="bg-secondary text-secondary-foreground px-3 py-1 rounded-full text-sm">Modern Kitchen</span>
                            <span class="bg-secondary text-secondary-foreground px-3 py-1 rounded-full text-sm">Hardwood Floors</span>
                            <span class="bg-secondary text-secondary-foreground px-3 py-1 rounded-full text-sm">Central AC</span>
                        </div>
                        </div>
                    </div>
                <div id="modalListingAgent" class="border-t pt-4">
                    <h3 class="text-xl font-semibold mb-3">Listing Agent</h3>
                    <div class="flex items-center gap-4">
                        <img id="modalListingAgentImage" src="" alt="Listing Agent" class="w-20 h-20 rounded-lg object-cover border border-gray-200 shadow-sm">
                        <div>
                            <p id="modalListingAgentName" class="text-base font-medium text-foreground mb-1">Not specified</p>
                            <p class="text-sm text-muted-foreground">Courtesy to listing agent</p>
                        </div>
                    </div>
                </div>
                <div id="modalDescription" class="hidden">
                    <h3 class="text-xl font-semibold mb-4">Description</h3>
                    <p id="modalDescriptionText" class="text-muted-foreground leading-relaxed">-</p>
                </div>
                <div class="border-t pt-4">
                    <h3 class="text-xl font-semibold mb-4">Contact Raj</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <a id="modalContactPhone" href="tel:832-785-0140" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-12 px-4 py-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-phone">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                            Call Raj
                        </a>
                        <a id="modalContactEmail" href="mailto:raj.gupta@kw.com" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border bg-background h-12 px-4 py-2 border-primary text-primary hover:bg-primary hover:text-primary-foreground">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mail">
                                <rect width="20" height="16" x="2" y="4" rx="2"></rect>
                                <path d="m22 7-10 5L2 7"></path>
                            </svg>
                            Email Raj
                        </a>
                    </div>
                    <p class="text-sm text-muted-foreground mt-3 text-center">Get expert advice on this property</p>
                </div>
                    </div>
            <button type="button" onclick="closePropertyModal()" class="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity data-[state=open]:bg-accent data-[state=open]:text-muted-foreground hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x h-4 w-4">
                    <path d="M18 6 6 18"></path>
                    <path d="m6 6 12 12"></path>
                </svg>
                <span class="sr-only">Close</span>
            </button>
                    </div>
                </div>
                
    <script>
        let currentMediaIndex = 0;
        let propertyMedia = []; // Array of {type: 'image'|'video', url: string, alt?: string}
        
        // Handle "View Details" buttons safely via data attributes
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('.view-details');
            if (!btn) return;
            const imagesRaw = btn.dataset.images || '';
            openPropertyModal(
                btn.dataset.id,
                btn.dataset.title || '',
                btn.dataset.location || '',
                btn.dataset.price || '',
                btn.dataset.type || '',
                btn.dataset.bedrooms || '',
                btn.dataset.bathrooms || '',
                btn.dataset.area || '',
                btn.dataset.description || '',
                imagesRaw,
                btn.dataset.status || '',
                btn.dataset.agentName || '',
                btn.dataset.agentImage || '',
                btn.dataset.mainImage || '',
                btn.dataset.contactEmail || 'raj.gupta@kw.com',
                btn.dataset.contactPhone || '(832) 785-0140',
                btn.dataset.media || '[]'
            );
        });
        
        function openPropertyModal(id, title, location, price, propertyType, bedrooms, bathrooms, area, description, additionalImages, propertyStatus, listingAgentName, listingAgentImageUrl, mainImage, contactEmail, contactPhone, mediaData) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modalLocation').textContent = location;
            
            // Update contact links
            const contactPhoneLink = document.getElementById('modalContactPhone');
            const contactEmailLink = document.getElementById('modalContactEmail');
            if (contactPhoneLink && contactPhone) {
                contactPhoneLink.href = 'tel:' + contactPhone.replace(/[^\d+]/g, '');
            }
            if (contactEmailLink && contactEmail) {
                contactEmailLink.href = 'mailto:' + contactEmail;
            }
            
            // Format price - don't show for sold/leased properties
            const priceElement = document.getElementById('modalPrice');
            const priceRow = priceElement.closest('.flex.justify-between');
            if (propertyStatus === 'just_sold' || propertyStatus === 'for_lease') {
                // Hide price for sold/leased properties
                if (priceRow) priceRow.style.display = 'none';
            } else {
                // Show price (handle as text, can be "upper 800s" or numeric)
                if (priceRow) priceRow.style.display = 'flex';
                if (price && price.trim()) {
                    // Check if price is numeric
                    const numericPrice = parseFloat(price);
                    if (!isNaN(numericPrice)) {
                        // It's a number, format it
                        if (propertyType === 'lease') {
                            priceElement.textContent = '$' + numericPrice.toLocaleString() + '/month';
                        } else {
                            priceElement.textContent = '$' + numericPrice.toLocaleString();
                        }
                    } else {
                        // It's text like "upper 800s", display as-is
                        priceElement.textContent = price;
                    }
                } else {
                    priceElement.textContent = '-';
                }
            }
            
            // Status
            const statusElement = document.getElementById('modalStatus');
            if (statusElement) {
                statusElement.textContent = propertyStatus ? propertyStatus.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : '-';
            }
            
            document.getElementById('modalBedrooms').textContent = bedrooms || '-';
            document.getElementById('modalBathrooms').textContent = bathrooms || '-';
            document.getElementById('modalArea').textContent = area ? parseFloat(area).toLocaleString() : '-';
            
            // Listing agent - always show the section
            const agentSection = document.getElementById('modalListingAgent');
            const agentNameEl = document.getElementById('modalListingAgentName');
            const agentImgEl = document.getElementById('modalListingAgentImage');
            
            // Always show the section
            if (agentSection) agentSection.classList.remove('hidden');
            
            // Set agent name
            if (agentNameEl) {
                if (listingAgentName && listingAgentName.trim()) {
                    agentNameEl.textContent = listingAgentName;
                } else {
                    agentNameEl.textContent = 'Not specified';
                }
            }
            
            // Set agent image
            if (agentImgEl) {
                if (listingAgentImageUrl && listingAgentImageUrl.trim()) {
                    agentImgEl.src = listingAgentImageUrl;
                    agentImgEl.classList.remove('hidden');
                } else {
                    agentImgEl.classList.add('hidden');
                }
            }
            
            // Handle description
            if (description && description.trim()) {
                document.getElementById('modalDescriptionText').textContent = description;
                document.getElementById('modalDescription').classList.remove('hidden');
            } else {
                document.getElementById('modalDescription').classList.add('hidden');
            }
            
            // Set up media (images + videos)
            setupPropertyMedia(id, title, additionalImages, mainImage, mediaData);
            
            // Set up features based on property data
            setupPropertyFeatures(bedrooms, bathrooms, area, propertyType);
            
            document.getElementById('propertyModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function parseImageList(imagesString) {
            if (!imagesString || !imagesString.trim()) return [];
            let raw = imagesString.trim();
            
            // Decode HTML entities (fix escaped semicolons in base64 data URLs)
            const textarea = document.createElement('textarea');
            textarea.innerHTML = raw;
            raw = textarea.value;
            
            // Try JSON array
            if (raw.startsWith('[') && raw.endsWith(']')) {
                try {
                    const arr = JSON.parse(raw);
                    if (Array.isArray(arr)) return arr.filter(Boolean).map(url => {
                        // Decode HTML entities in each URL
                        const ta = document.createElement('textarea');
                        ta.innerHTML = url;
                        return ta.value;
                    });
                } catch (_) {}
            }
            
            // Try common separators
            const separators = ['|||', '\n', ',', '|'];
            for (const sep of separators) {
                if (raw.includes(sep)) {
                    return raw.split(sep).map(s => {
                        const trimmed = s.trim();
                        if (!trimmed) return null;
                        // Decode HTML entities in each URL
                        const ta = document.createElement('textarea');
                        ta.innerHTML = trimmed;
                        return ta.value;
                    }).filter(Boolean);
                }
            }
            
            // Decode single URL
            const ta = document.createElement('textarea');
            ta.innerHTML = raw;
            return [ta.value];
        }
        
        function setupPropertyMedia(propertyId, title, additionalImages, mainImage, mediaData) {
            propertyMedia = [];
            const seenUrls = new Set(); // Track seen URLs to avoid duplicates
            
            // Try to parse mediaData (JSON array with type and url)
            try {
                // Remove any HTML entities and clean the string
                let cleanMediaData = mediaData || '[]';
                if (typeof cleanMediaData === 'string') {
                    // Decode HTML entities
                    const textarea = document.createElement('textarea');
                    textarea.innerHTML = cleanMediaData;
                    cleanMediaData = textarea.value;
                }
                
                const mediaArray = JSON.parse(cleanMediaData);
                console.log('Parsed media array:', mediaArray);
                
                if (Array.isArray(mediaArray) && mediaArray.length > 0) {
                    mediaArray.forEach((item) => {
                        if (item && item.url && item.url.trim() && !seenUrls.has(item.url.trim())) {
                            seenUrls.add(item.url.trim());
                            propertyMedia.push({
                                type: item.type || 'image',
                                url: item.url.trim(),
                                alt: title
                            });
                        }
                    });
                }
            } catch (e) {
                console.error('Could not parse mediaData:', e, 'Raw data:', mediaData);
                console.log('Falling back to images only');
            }
            
            // Fallback: Parse all images from additionalImages (which includes main + all others)
            if (propertyMedia.length === 0) {
                const imageUrls = parseImageList(additionalImages);
                
                // Add all images, avoiding duplicates
                imageUrls.forEach((url) => {
                    if (url && url.trim() && !seenUrls.has(url.trim())) {
                        seenUrls.add(url.trim());
                        propertyMedia.push({
                            type: 'image',
                            url: url.trim(),
                            alt: title
                        });
                    }
                });
                
                // Also add main image if it's not already in the list
                if (mainImage && mainImage.trim() && !seenUrls.has(mainImage.trim())) {
                    propertyMedia.unshift({ // Add at the beginning
                        type: 'image',
                        url: mainImage.trim(),
                        alt: title
                    });
                }
            }
            
            // If no media found, use a placeholder image
            if (propertyMedia.length === 0) {
                propertyMedia.push({
                    type: 'image',
                    url: '/static/Images/placeholder-property.jpg',
                    alt: title
                });
            }
            
            console.log('Property media loaded:', propertyMedia.length, propertyMedia); // Debug
            
            // Set up carousel
            currentMediaIndex = 0;
            updateMediaDisplay();
            setupMediaNavigation();
        }
        
        function updateMediaDisplay() {
            const imageElement = document.getElementById('modalImageSrc');
            const videoElement = document.getElementById('modalVideoSrc');
            const navigation = document.getElementById('imageNavigation');
            const dotsContainer = document.getElementById('imageDots');
            
            if (propertyMedia.length > 0 && currentMediaIndex >= 0 && currentMediaIndex < propertyMedia.length) {
                const currentMedia = propertyMedia[currentMediaIndex];
                
                // Hide both elements first
                imageElement.classList.add('hidden');
                videoElement.classList.add('hidden');
                
                if (currentMedia.type === 'video') {
                    // Show video
                    let videoUrl = currentMedia.url;
                    
                    // Handle YouTube/Vimeo embed URLs - use iframe instead of video element
                    if (videoUrl.includes('youtube.com/embed/') || videoUrl.includes('player.vimeo.com/video/')) {
                        // Create or update iframe for YouTube/Vimeo
                        let iframe = document.getElementById('modalVideoIframe');
                        if (!iframe) {
                            iframe = document.createElement('iframe');
                            iframe.id = 'modalVideoIframe';
                            iframe.className = 'w-full h-full max-h-[24rem] transition-opacity duration-300';
                            iframe.style.aspectRatio = '16/9'; // Standard video aspect ratio
                            iframe.style.minHeight = '16rem';
                            iframe.setAttribute('frameborder', '0');
                            iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                            iframe.setAttribute('allowfullscreen', '');
                            iframe.setAttribute('oncontextmenu', 'return false;');
                            iframe.style.pointerEvents = 'auto';
                            videoElement.parentElement.appendChild(iframe);
                        }
                        iframe.src = videoUrl;
                        iframe.classList.remove('hidden');
                        videoElement.classList.add('hidden');
                    } else {
                        // Use video element for direct video files
                        let iframe = document.getElementById('modalVideoIframe');
                        if (iframe) iframe.classList.add('hidden');
                        
                        // Load video to get its dimensions
                        videoElement.src = videoUrl;
                        videoElement.classList.remove('hidden');
                        
                        // Additional protection: prevent video download
                        videoElement.addEventListener('contextmenu', function(e) {
                            e.preventDefault();
                            return false;
                        });
                        videoElement.addEventListener('dragstart', function(e) {
                            e.preventDefault();
                            return false;
                        });
                        
                        // Wait for video metadata to load, then adjust display based on aspect ratio
                        videoElement.onloadedmetadata = function() {
                            const video = this;
                            const container = video.parentElement;
                            const videoAspectRatio = video.videoWidth / video.videoHeight;
                            const containerWidth = container.offsetWidth || 600; // Fallback width
                            const containerHeight = Math.min(container.offsetHeight || 384, 384); // Max 24rem
                            const containerAspectRatio = containerWidth / containerHeight;
                            
                            // Reset styles first
                            video.style.width = '';
                            video.style.height = '';
                            video.style.maxWidth = '';
                            video.style.maxHeight = '';
                            
                            // Adjust video display based on aspect ratio
                            if (videoAspectRatio > containerAspectRatio) {
                                // Video is wider (landscape like 16:9) - fit to width
                                video.style.width = '100%';
                                video.style.height = 'auto';
                                video.style.maxHeight = '24rem';
                                video.style.objectFit = 'contain';
                            } else {
                                // Video is taller (portrait like 9:16) - fit to height, center horizontally
                                video.style.width = 'auto';
                                video.style.height = '100%';
                                video.style.maxHeight = '24rem';
                                video.style.maxWidth = '100%';
                                video.style.objectFit = 'contain';
                            }
                        };
                        
                        // Pause any previous video
                        videoElement.pause();
                    }
                } else {
                    // Hide iframe when showing image
                    let iframe = document.getElementById('modalVideoIframe');
                    if (iframe) iframe.classList.add('hidden');
                    // Show image
                    imageElement.src = '';
                    imageElement.style.opacity = '0';
                    
                    // Ensure image loads properly
                    imageElement.onerror = function() {
                        console.error('Failed to load image:', currentMediaIndex, currentMedia.url.substring(0, 100));
                        imageElement.style.opacity = '1';
                        // Try next media if available
                        if (propertyMedia.length > currentMediaIndex + 1) {
                            currentMediaIndex++;
                            updateMediaDisplay();
                        }
                    };
                    
                    imageElement.onload = function() {
                        console.log('Image loaded successfully:', currentMediaIndex, propertyMedia.length);
                        imageElement.style.opacity = '1';
                    };
                    
                    // Set new image source
                    imageElement.src = currentMedia.url;
                    imageElement.alt = currentMedia.alt || 'Property Image';
                    imageElement.classList.remove('hidden');
                    
                    // Force opacity back in case onload doesn't fire (for cached images)
                    setTimeout(() => {
                        if (imageElement.complete) {
                            imageElement.style.opacity = '1';
                        }
                    }, 100);
                }
                
                // Show/hide navigation based on number of media items
                if (propertyMedia.length > 1) {
                    navigation.classList.remove('hidden');
                } else {
                    navigation.classList.add('hidden');
                }
                
                setupImageDots();
            } else {
                console.error('No media or invalid index:', propertyMedia.length, currentMediaIndex);
            }
        }
        
        function setupMediaNavigation() {
            const prevButton = document.getElementById('prevImage');
            const nextButton = document.getElementById('nextImage');
            
            if (prevButton) {
                prevButton.onclick = () => {
                    if (propertyMedia.length > 0) {
                        // Pause current video if playing
                        const videoElement = document.getElementById('modalVideoSrc');
                        if (videoElement && !videoElement.classList.contains('hidden')) {
                            videoElement.pause();
                        }
                        // Clear iframe src to stop YouTube/Vimeo videos
                        const iframe = document.getElementById('modalVideoIframe');
                        if (iframe && !iframe.classList.contains('hidden')) {
                            iframe.src = '';
                        }
                        currentMediaIndex = (currentMediaIndex - 1 + propertyMedia.length) % propertyMedia.length;
                        console.log('Previous media:', currentMediaIndex, propertyMedia.length);
                        updateMediaDisplay();
                    }
                };
            }
            
            if (nextButton) {
                nextButton.onclick = () => {
                    if (propertyMedia.length > 0) {
                        // Pause current video if playing
                        const videoElement = document.getElementById('modalVideoSrc');
                        if (videoElement && !videoElement.classList.contains('hidden')) {
                            videoElement.pause();
                        }
                        // Clear iframe src to stop YouTube/Vimeo videos
                        const iframe = document.getElementById('modalVideoIframe');
                        if (iframe && !iframe.classList.contains('hidden')) {
                            iframe.src = '';
                        }
                        currentMediaIndex = (currentMediaIndex + 1) % propertyMedia.length;
                        console.log('Next media:', currentMediaIndex, propertyMedia.length);
                        updateMediaDisplay();
                    }
                };
            }
        }
        
        function setupImageDots() {
            const dotsContainer = document.getElementById('imageDots');
            dotsContainer.innerHTML = '';
            
            propertyMedia.forEach((media, index) => {
                const dot = document.createElement('button');
                dot.className = `w-3 h-3 rounded-full transition-all border-2 ${
                    index === currentMediaIndex 
                        ? 'bg-white border-white shadow-lg' 
                        : 'bg-white bg-opacity-30 border-white border-opacity-50 hover:bg-opacity-60'
                }`;
                // Add video indicator
                if (media.type === 'video') {
                    dot.innerHTML = '<svg class="w-2 h-2" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
                }
                dot.onclick = () => {
                    // Pause current video if playing
                    const videoElement = document.getElementById('modalVideoSrc');
                    if (videoElement && !videoElement.classList.contains('hidden')) {
                        videoElement.pause();
                    }
                    currentMediaIndex = index;
                    updateMediaDisplay();
                };
                dotsContainer.appendChild(dot);
            });
        }
        
        function setupPropertyFeatures(bedrooms, bathrooms, area, propertyType) {
            console.log('Setting up features:', {bedrooms, bathrooms, area, propertyType});
            const features = [];
            
            // Add features based on available data
            if (bedrooms && bedrooms > 0) {
                features.push(`${bedrooms} Bedroom${bedrooms > 1 ? 's' : ''}`);
            }
            
            if (bathrooms && bathrooms > 0) {
                features.push(`${bathrooms} Bathroom${bathrooms > 1 ? 's' : ''}`);
            }
            
            if (area && area > 0) {
                features.push(`${parseInt(area).toLocaleString()} sq ft`);
            }
            
            // Add property type specific features
            if (propertyType === 'lease') {
                features.push('Available for Lease');
            } else {
                features.push('Available for Sale');
            }
            
            // Add some common features if we have basic data
            if (bedrooms && bathrooms) {
                features.push('Modern Design');
                features.push('Well Maintained');
            }
            
            console.log('Generated features:', features);
            
            const featuresContainer = document.getElementById('modalFeatures');
            if (features.length > 0) {
                featuresContainer.innerHTML = features.map(feature => 
                    `<span class="bg-secondary text-secondary-foreground px-3 py-1 rounded-full text-sm">${feature}</span>`
                ).join('');
            } else {
                featuresContainer.innerHTML = '<span class="text-muted-foreground text-sm">No additional features listed</span>';
            }
        }
        
        function closePropertyModal() {
            document.getElementById('propertyModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // Function removed - contact buttons now use direct links
        
        // Close modal when clicking outside
        document.getElementById('propertyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePropertyModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePropertyModal();
            }
        });
    </script>

    <script src="{% static 'js/django-main-fixed.js' %}"></script>
</body>
</html>

