{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open House Schedule - {{ brand_name }}</title>
    <meta name="description"
          content="Visit our beautiful properties at your convenience. Book your open house viewing with {{ brand_name }}.">
    <link rel="icon" type="image/png" href="{% static 'favicon.png' %}">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap"
          rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/django-main.css' %}">
    <link rel="stylesheet" href="{% static 'css/modal-gallery.css' %}">

    <style>
        /* Ensure CSS variables are available */
        :root {
            --border: 220 13% 91%;
            --background: 0 0% 100%;
            --foreground: 224 15% 15%;
            --primary: 224 30% 12%;
            --primary-foreground: 0 0% 100%;
            --muted-foreground: 224 10% 45%;
            --secondary: 220 13% 97%;
            --accent: 43 87% 52%;
        }

        /* Missing utility classes for navbar */
        .border-border {
            border-color: hsl(var(--border));
        }

        .shadow-soft {
            box-shadow: 0 2px 4px hsl(224 30% 12% / .06);
        }

        /* Fix navbar desktop menu visibility - override hidden on md screens */
        @media (min-width: 768px) {
            /* Show navbar desktop menu on medium screens and up */
            nav div.hidden.items-center.space-x-1 {
                display: flex !important;
            }
        }

        /* Open House Card Description - Scrollable */
        .open-house-description-container {
            max-height: 6rem; /* Approximately 4 lines */
            overflow-y: auto;
            overflow-x: hidden;
            line-height: 1.5rem;
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
        }

        .open-house-description-container::-webkit-scrollbar {
            width: 6px;
        }

        .open-house-description-container::-webkit-scrollbar-track {
            background: #f7fafc;
            border-radius: 3px;
        }

        .open-house-description-container::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }

        .open-house-description-container::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .open-house-description {
            margin: 0;
            padding: 0;
        }

        /* Ensure image container maintains aspect ratio */
        .open-house-image-container {
            height: 16rem; /* h-64 equivalent */
        }

        /* Small tablets and large phones (640px - 767px) */
        @media (min-width: 640px) and (max-width: 767px) {
            .open-house-image-container {
                height: 18rem;
            }
        }

        /* Tablet sizes (768px - 1023px) - prevent layout breaking */
        @media (min-width: 768px) and (max-width: 1023px) {
            .open-house-image-container {
                height: 20rem; /* Intermediate height for tablets */
            }

            /* Force single column layout on tablets to prevent breaking */
            .grid[class*="lg:grid-cols-2"] {
                grid-template-columns: 1fr !important;
            }

            /* Prevent content overflow */
            .grid[class*="lg:grid-cols-2"] > div {
                min-width: 0;
                overflow: hidden;
                width: 100%;
            }

            /* Ensure images don't break layout */
            .open-house-image-container img {
                max-width: 100%;
                height: auto;
                object-fit: cover;
            }
        }

        /* Desktop sizes (1024px+) */
        @media (min-width: 1024px) {
            .open-house-image-container {
                height: 100%;
                min-height: 25rem;
            }
        }

        /* Modal styling to ensure visibility */
        #bookingModal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 9999 !important;
            background-color: rgba(0, 0, 0, 0.5) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 1rem !important;
        }

        #bookingModal .modal-content {
            background-color: white !important;
            border-radius: 0.5rem !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
            max-width: 42rem !important;
            width: 100% !important;
            max-height: 90vh !important;
            overflow-y: auto !important;
        }

        #bookingModal input,
        #bookingModal select,
        #bookingModal textarea {
            width: 100% !important;
            padding: 0.5rem 0.75rem !important;
            border: 1px solid #d1d5db !important;
            border-radius: 0.375rem !important;
            font-size: 0.875rem !important;
            line-height: 1.25rem !important;
        }

        #bookingModal input:focus,
        #bookingModal select:focus,
        #bookingModal textarea:focus {
            outline: none !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }

        #bookingModal button {
            cursor: pointer !important;
            transition: all 0.15s ease-in-out !important;
        }

        #bookingModal button:hover {
            opacity: 0.9 !important;
        }

        /* Ensure modal is visible and properly positioned */
        body.modal-open {
            overflow: hidden !important;
        }

        #bookingModal {
            backdrop-filter: blur(4px) !important;
        }

        #bookingModal .modal-content {
            animation: modalSlideIn 0.3s ease-out !important;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>

    <!-- Define gallery functions in head to ensure they're available before HTML renders -->
    <script>
        // Define gallery functions immediately in head to ensure global accessibility
        // These functions must be defined before any HTML that uses them
        (function () {
            'use strict';

            // Initialize openHouseImages object
            window.openHouseImages = window.openHouseImages || {};

            // Define gallery functions
            window.openImageGallery = function (openHouseId) {
                if (!window.openHouseImages || !window.openHouseImages[openHouseId]) {
                    return;
                }

                const imageData = window.openHouseImages[openHouseId];
                const images = imageData.images.filter(img => img); // Remove empty images

                if (images.length === 0) {
                    return;
                }

                let currentIndex = 0;

                // Create modal HTML
                const modalHTML = `
                    <div id="imageGalleryModal" class="image-modal-backdrop" onclick="if(event.target.id === 'imageGalleryModal') window.closeImageGallery()">
                        <div class="image-modal-container" onclick="event.stopPropagation()">
                            <div class="image-modal-header">
                                <h3 class="image-modal-title">${imageData.title}</h3>
                                <div class="image-modal-header-right">
                                    <span class="image-modal-counter">
                                        <span id="currentImageIndex">1</span> / ${images.length}
                                    </span>
                                    <button class="image-modal-close" onclick="window.closeImageGallery()" aria-label="Close">&times;</button>
                                </div>
                            </div>
                            <div class="image-modal-content">
                                <button class="image-modal-nav prev" onclick="window.navigateGallery(-1)" id="prevBtn" ${images.length <= 1 ? 'style="display:none"' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="m15 18-6-6 6-6"></path>
                                    </svg>
                                </button>
                                <div class="image-modal-image-container">
                                    <img id="galleryMainImage" src="${images[0]}" alt="${imageData.title}" class="image-modal-image" style="max-width: calc(90vw - 4rem); max-height: ${imageData.description ? 'calc(90vh - 400px)' : 'calc(90vh - 250px)'}; object-fit: contain; object-position: center; width: auto; height: auto; margin: 0 auto; padding: 0; display: block;">
                                </div>
                                <button class="image-modal-nav next" onclick="window.navigateGallery(1)" id="nextBtn" ${images.length <= 1 ? 'style="display:none"' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="m9 18 6-6-6-6"></path>
                                    </svg>
                                </button>
                            </div>
                            ${images.length > 1 ? `
                            <div class="image-modal-thumbnails">
                                <div class="image-modal-thumbnail-strip" id="thumbnailStrip">
                                    ${images.map((img, idx) => `
                                        <img src="${img}" alt="Thumbnail ${idx + 1}" 
                                             class="image-modal-thumbnail ${idx === 0 ? 'active' : ''}" 
                                             onclick="window.goToImage(${idx})">
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                            ${imageData.description ? `
                            <div class="image-modal-description-section">
                                <h4 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; margin-top: 0;">Property Description</h4>
                                <p style="color: #4b5563; line-height: 1.6; margin: 0; white-space: pre-wrap;">${imageData.description}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                // Remove existing modal if any
                const existingModal = document.getElementById('imageGalleryModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                document.body.style.overflow = 'hidden';

                // Store current index globally for navigation
                window.currentGalleryIndex = 0;
                window.currentGalleryImages = images;

                // Keyboard navigation
                document.addEventListener('keydown', window.handleGalleryKeyPress);
            };

            window.navigateGallery = function (direction) {
                if (!window.currentGalleryImages) return;

                const images = window.currentGalleryImages;
                let newIndex = window.currentGalleryIndex + direction;

                if (newIndex < 0) {
                    newIndex = images.length - 1;
                } else if (newIndex >= images.length) {
                    newIndex = 0;
                }

                window.goToImage(newIndex);
            };

            window.goToImage = function (index) {
                if (!window.currentGalleryImages) return;

                const images = window.currentGalleryImages;
                if (index < 0 || index >= images.length) return;

                window.currentGalleryIndex = index;

                const mainImage = document.getElementById('galleryMainImage');
                if (mainImage) {
                    mainImage.src = images[index];
                }

                // Update counter
                const counter = document.getElementById('currentImageIndex');
                if (counter) {
                    counter.textContent = index + 1;
                }

                // Update thumbnails
                const thumbnails = document.querySelectorAll('.image-modal-thumbnail');
                thumbnails.forEach((thumb, idx) => {
                    if (idx === index) {
                        thumb.classList.add('active');
                    } else {
                        thumb.classList.remove('active');
                    }
                });
            };

            window.handleGalleryKeyPress = function (e) {
                if (document.getElementById('imageGalleryModal')) {
                    if (e.key === 'ArrowLeft') {
                        window.navigateGallery(-1);
                    } else if (e.key === 'ArrowRight') {
                        window.navigateGallery(1);
                    } else if (e.key === 'Escape') {
                        window.closeImageGallery();
                    }
                }
            };

            window.closeImageGallery = function () {
                const modal = document.getElementById('imageGalleryModal');
                if (modal) {
                    modal.remove();
                    document.body.style.overflow = 'auto';
                    document.removeEventListener('keydown', window.handleGalleryKeyPress);
                }
            };
        })();
    </script>

</head>
<body>
{% include 'Raj/social_media_sidebar.html' %}
{% include 'Raj/navbar.html' %}

<!-- Hero Section -->
<section class="bg-gradient-surface py-12 my-4">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-foreground mb-4">Open House Schedule</h1>
        </div>
    </div>
</section>

<!-- Open House Properties -->
<section class="py-16 bg-background">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            {% if open_houses %}
                <div id="upcoming-section">
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="upcoming-grid">
                        {% for open_house in open_houses %}
                        <div class="open-house-card rounded-lg border bg-card text-card-foreground shadow-sm overflow-hidden shadow-soft hover:shadow-medium transition-all duration-300 group"
                             data-date="{{ open_house.open_house_date|date:'Y-m-d' }}">

                            <div class="relative overflow-hidden">
                                {% if open_house.get_main_image_url %}
                                    <img src="{{ open_house.get_main_image_url }}" alt="{{ open_house.title }}" class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300 cursor-pointer" data-open-house-id="{{ open_house.id }}" onclick="if(window.openImageGallery && typeof window.openImageGallery === 'function') { window.openImageGallery({{ open_house.id }}); }">
                                {% else %}
                                    <img src="{% static 'images/property-1.jpg' %}" alt="{{ open_house.title }}" class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300 cursor-pointer" data-open-house-id="{{ open_house.id }}" onclick="if(window.openImageGallery && typeof window.openImageGallery === 'function') { window.openImageGallery({{ open_house.id }}); }">
                                {% endif %}
                                <div class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent hover:bg-primary/80 absolute top-4 left-4 bg-accent text-accent-foreground">Open House</div>

                                {% if open_house.get_main_image_url or open_house.images.all %}
                                    {% with total_images=open_house.images.all|length %}
                                        {% if open_house.get_main_image_url %}
                                            {% with total_images=total_images|add:1 %}
                                                {% if total_images > 1 %}
                                                    <div class="absolute bottom-4 right-4 bg-black bg-opacity-70 text-white px-3 py-1 rounded-full text-sm font-medium cursor-pointer" data-gallery-id="{{ open_house.id }}" onclick="event.stopPropagation(); if(window.openImageGallery && typeof window.openImageGallery === 'function') { window.openImageGallery({{ open_house.id }}); }">
                                                        View {{ total_images }} photos
                                                    </div>
                                                {% endif %}
                                            {% endwith %}
                                        {% else %}
                                            {% if total_images > 1 %}
                                                <div class="absolute bottom-4 right-4 bg-black bg-opacity-70 text-white px-3 py-1 rounded-full text-sm font-medium cursor-pointer" data-gallery-id="{{ open_house.id }}" onclick="event.stopPropagation(); if(window.openImageGallery && typeof window.openImageGallery === 'function') { window.openImageGallery({{ open_house.id }}); }">
                                                    View {{ total_images }} photos
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                            </div>

                            <div class="p-6">
                                <div class="flex items-center text-sm text-muted-foreground mb-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar w-4 h-4 mr-1">
                                        <path d="M8 2v4"></path>
                                        <path d="M16 2v4"></path>
                                        <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                                        <path d="M3 10h18"></path>
                                    </svg>
                                    <span>{{ open_house.open_house_date|date:"M j, Y" }}</span>
                                    <span class="mx-2">â€¢</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock w-4 h-4 mr-1">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    <span>{{ open_house.open_house_time|time:"g:i A" }}{% if open_house.open_house_end_time %} - {{ open_house.open_house_end_time|time:"g:i A" }}{% endif %}</span>
                                </div>

                                <h3 class="text-lg font-semibold text-foreground mb-2 line-clamp-2">{{ open_house.title }}</h3>

                                <div class="flex items-center text-foreground mb-3 text-base font-medium">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin w-4 h-4 mr-2 text-muted-foreground flex-shrink-0">
                                        <path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                    <span class="line-clamp-1">{{ open_house.property_address }}</span>
                                </div>

                                <div class="flex items-center space-x-4 text-sm text-muted-foreground mb-3">
                                    {% if open_house.bedrooms %}
                                    <span>{{ open_house.bedrooms }} beds</span>
                                    {% endif %}
                                    {% if open_house.bathrooms %}
                                    <span>{{ open_house.bathrooms }} baths</span>
                                    {% endif %}
                                    {% if open_house.area_sqft %}
                                    <span>{{ open_house.area_sqft|intcomma }} sqft</span>
                                    {% endif %}
                                </div>

                                <div class="text-lg font-bold text-primary mb-4">${{ open_house.price|floatformat:0|intcomma }}</div>

                                <div class="flex items-center justify-between gap-4 mb-4">
                                    <button
                                        class="flex-1 inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border bg-gray-100 h-9 rounded-md px-3 py-2 border-primary text-primary hover:bg-primary hover:text-primary-foreground"
                                        onclick="handleContactRajClick(this)"
                                        data-open-house-id="{{ open_house.id }}"
                                        data-title="{{ open_house.title }}"
                                        data-address="{{ open_house.property_address }}"
                                        data-date="{{ open_house.open_house_date|date:"M j, Y" }}"
                                        data-time="{{ open_house.open_house_time|time:"g:i A" }}"
                                        data-end-time="{% if open_house.open_house_end_time %}{{ open_house.open_house_end_time|time:"g:i A" }}{% endif %}"
                                        data-price="{{ open_house.price }}">
                                        Contact Raj
                                    </button>
                                    <button
                                        class="flex-1 inline-flex items-center justify-center gap-2 whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border bg-gray-100 h-9 rounded-md px-3 py-2 border-primary text-primary hover:bg-primary hover:text-primary-foreground"
                                        onclick="if(window.openImageGallery && typeof window.openImageGallery === 'function') { window.openImageGallery({{ open_house.id }}); }">
                                        View Details
                                    </button>
                                </div>

                                {% if open_house.listing_agent_name %}
                                <div class="flex items-center gap-3 pt-3 border-t">
                                    {% if open_house.get_listing_agent_image_url %}
                                    <img src="{{ open_house.get_listing_agent_image_url }}" alt="{{ open_house.listing_agent_name }}" class="w-10 h-10 rounded-full object-cover border-2 border-gray-200">
                                    {% endif %}
                                    <div>
                                        <p class="text-xs text-muted-foreground mb-1">Listing By</p>
                                        <p class="text-sm font-medium text-foreground">
                                            {% if open_house.listing_agent_link %}
                                                <a href="{{ open_house.listing_agent_link }}" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">{{ open_house.listing_agent_name }}</a>
                                            {% else %}
                                                {{ open_house.listing_agent_name }}
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div id="past-section" class="mt-24 hidden">
                    <div class="flex items-center mb-8">
                        <div class="h-px bg-border flex-1"></div>
                        <h2 class="text-2xl md:text-3xl font-bold text-muted-foreground px-6 uppercase tracking-wide">Recent Open Houses</h2>
                        <div class="h-px bg-border flex-1"></div>
                    </div>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="past-grid">
                        </div>
                </div>

                <script>
        (function () {
            'use strict';

            // Initialize global object (it starts empty now!)
            window.openHouseImages = window.openHouseImages || {};

            // NEW: Fetch data before opening gallery
            window.openImageGallery = function (openHouseId) {
                // 1. If we already have data, open immediately
                if (window.openHouseImages[openHouseId]) {
                    renderGallery(openHouseId);
                    return;
                }

                // 2. Show a loading cursor or simple indicator
                document.body.style.cursor = 'wait';

                // 3. Fetch from API
                fetch(`/api/open-house/${openHouseId}/`)
                    .then(response => response.json())
                    .then(data => {
                        document.body.style.cursor = 'default';
                        // Populate the data object
                        window.openHouseImages[openHouseId] = {
                            title: data.title,
                            description: data.description,
                            images: data.images
                        };
                        // Now open the gallery
                        renderGallery(openHouseId);
                    })
                    .catch(err => {
                        document.body.style.cursor = 'default';
                        console.error("Error loading images:", err);
                        alert("Could not load gallery images. Please try again.");
                    });
            };

            // Helper function to render the modal (Moved from previous logic)
            function renderGallery(openHouseId) {
                const imageData = window.openHouseImages[openHouseId];
                const images = imageData.images.filter(img => img); // Remove empty

                if (images.length === 0) return;

                let currentIndex = 0;

                // Create modal HTML
                const modalHTML = `
                    <div id="imageGalleryModal" class="image-modal-backdrop" onclick="if(event.target.id === 'imageGalleryModal') window.closeImageGallery()">
                        <div class="image-modal-container" onclick="event.stopPropagation()">
                            <div class="image-modal-header">
                                <h3 class="image-modal-title">${imageData.title}</h3>
                                <div class="image-modal-header-right">
                                    <span class="image-modal-counter">
                                        <span id="currentImageIndex">1</span> / ${images.length}
                                    </span>
                                    <button class="image-modal-close" onclick="window.closeImageGallery()" aria-label="Close">&times;</button>
                                </div>
                            </div>
                            <div class="image-modal-content">
                                <button class="image-modal-nav prev" onclick="window.navigateGallery(-1)" id="prevBtn" ${images.length <= 1 ? 'style="display:none"' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"></path></svg>
                                </button>
                                <div class="image-modal-image-container">
                                    <img id="galleryMainImage" src="${images[0]}" alt="${imageData.title}" class="image-modal-image" style="max-width: calc(90vw - 4rem); max-height: ${imageData.description ? 'calc(90vh - 400px)' : 'calc(90vh - 250px)'}; object-fit: contain; object-position: center; width: auto; height: auto; margin: 0 auto; padding: 0; display: block;">
                                </div>
                                <button class="image-modal-nav next" onclick="window.navigateGallery(1)" id="nextBtn" ${images.length <= 1 ? 'style="display:none"' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"></path></svg>
                                </button>
                            </div>
                            ${images.length > 1 ? `
                            <div class="image-modal-thumbnails">
                                <div class="image-modal-thumbnail-strip" id="thumbnailStrip">
                                    ${images.map((img, idx) => `
                                        <img src="${img}" alt="Thumbnail ${idx + 1}"
                                             class="image-modal-thumbnail ${idx === 0 ? 'active' : ''}"
                                             onclick="window.goToImage(${idx})">
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                            ${imageData.description ? `
                            <div class="image-modal-description-section">
                                <h4 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; margin-top: 0;">Property Description</h4>
                                <p style="color: #4b5563; line-height: 1.6; margin: 0; white-space: pre-wrap;">${imageData.description}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                const existingModal = document.getElementById('imageGalleryModal');
                if (existingModal) existingModal.remove();

                document.body.insertAdjacentHTML('beforeend', modalHTML);
                document.body.style.overflow = 'hidden';

                window.currentGalleryIndex = 0;
                window.currentGalleryImages = images;
                document.addEventListener('keydown', window.handleGalleryKeyPress);
            }

            // Navigation functions (Keep these global)
            window.navigateGallery = function (direction) {
                if (!window.currentGalleryImages) return;
                const images = window.currentGalleryImages;
                let newIndex = window.currentGalleryIndex + direction;
                if (newIndex < 0) newIndex = images.length - 1;
                else if (newIndex >= images.length) newIndex = 0;
                window.goToImage(newIndex);
            };

            window.goToImage = function (index) {
                if (!window.currentGalleryImages) return;
                const images = window.currentGalleryImages;
                if (index < 0 || index >= images.length) return;

                window.currentGalleryIndex = index;
                const mainImage = document.getElementById('galleryMainImage');
                if (mainImage) mainImage.src = images[index];

                const counter = document.getElementById('currentImageIndex');
                if (counter) counter.textContent = index + 1;

                const thumbnails = document.querySelectorAll('.image-modal-thumbnail');
                thumbnails.forEach((thumb, idx) => {
                    thumb.classList.toggle('active', idx === index);
                });
            };

            window.handleGalleryKeyPress = function (e) {
                if (document.getElementById('imageGalleryModal')) {
                    if (e.key === 'ArrowLeft') window.navigateGallery(-1);
                    else if (e.key === 'ArrowRight') window.navigateGallery(1);
                    else if (e.key === 'Escape') window.closeImageGallery();
                }
            };

            window.closeImageGallery = function () {
                const modal = document.getElementById('imageGalleryModal');
                if (modal) {
                    modal.remove();
                    document.body.style.overflow = 'auto';
                    document.removeEventListener('keydown', window.handleGalleryKeyPress);
                }
            };
        })();
    </script>
            {% else %}
                <div class="text-center py-16">
                    <div class="rounded-lg border bg-card text-card-foreground shadow-sm p-8 shadow-soft max-w-md mx-auto">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-x mx-auto mb-4 text-muted-foreground">
                            <path d="M8 2v4"></path>
                            <path d="M16 2v4"></path>
                            <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                            <path d="M3 10h18"></path>
                            <path d="m14.5 14.5 5 5"></path>
                            <path d="m19.5 14.5-5 5"></path>
                        </svg>
                        <h3 class="text-xl font-semibold text-foreground mb-2">No Open Houses Scheduled</h3>
                        <p class="text-muted-foreground mb-6">We don't have any open houses scheduled at the moment. Please check back later.</p>
                        <a href="{% url 'buy_lease' %}" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:bg-accent h-10 text-primary hover:text-primary-foreground px-4 py-2 bg-accent hover:shadow-accent">
                            View Available Properties
                        </a>
                </div>
            </div>
            {% endif %}
        </div>
    </section>

{% include 'Raj/footer.html' %}

<!-- Custom JavaScript -->
<script src="{% static 'js/django-main-fixed.js' %}"></script>

<script>
    // 1. Contact Raj Handler
    function handleContactRajClick(btn) {
        const d = btn.dataset;
        openBookingModal(d.openHouseId, d.title, d.address, d.date, d.time, d.endTime, d.price);
    }

    // 2. Sorting Logic (Runs automatically on load)
    document.addEventListener('DOMContentLoaded', function() {
        const upcomingGrid = document.getElementById('upcoming-grid');
        const pastGrid = document.getElementById('past-grid');
        const pastSection = document.getElementById('past-section');

        if (!upcomingGrid) return; // Exit if no grid found

        // Get all card elements
        const cards = Array.from(upcomingGrid.getElementsByClassName('open-house-card'));
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Normalize to midnight for fair comparison

        const upcoming = [];
        const past = [];

        cards.forEach(card => {
            const dateStr = card.getAttribute('data-date'); // Format: YYYY-MM-DD
            if (dateStr) {
                // Parse date safely (using split to avoid timezone issues)
                const [y, m, d] = dateStr.split('-').map(Number);
                const cardDate = new Date(y, m - 1, d);

                if (cardDate < today) {
                    past.push({ element: card, date: cardDate });
                } else {
                    upcoming.push({ element: card, date: cardDate });
                }
            }
        });

        // SORTING RULES:
        // Upcoming: Ascending (Closest date first: 10th, 15th...)
        upcoming.sort((a, b) => a.date - b.date);

        // Past: Descending (Most recent past date first: 9th, 8th...)
        past.sort((a, b) => b.date - a.date);

        // Re-append Upcoming cards in correct order
        upcoming.forEach(item => upcomingGrid.appendChild(item.element));

        // Handle Past cards
        if (past.length > 0) {
            past.forEach(item => {
                pastGrid.appendChild(item.element);
            });
            pastSection.classList.remove('hidden'); // Show the section
        } else {
            pastSection.classList.add('hidden');
        }
    });

    // 3. Modal Functions
    function openBookingModal(openHouseId, title, address, date, time, endTime, price) {
        // ... (Keep existing modal logic same as before)
        const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };

        const safeTitle = escapeHtml(title || '');
        const safeAddress = escapeHtml(address || '');
        const safeDate = escapeHtml(date || '');
        const safeTime = escapeHtml(time || '');
        const safeEndTime = endTime ? escapeHtml(endTime) : '';
        const priceNum = parseFloat(price) || 0;
        const formattedPrice = priceNum.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});

        const modalHTML = `
            <div id="bookingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4" style="z-index: 9999;">
                <div class="modal-content bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" style="background-color: white; border-radius: 0.5rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); max-width: 42rem;">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold" style="color: #111827; font-size: 1.25rem; font-weight: 700;">Get More Info</h3>
                            <button onclick="closeBookingModal()" class="text-gray-400 hover:text-gray-600" style="color: #9ca3af; transition: color 0.15s ease-in-out;">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.5rem; height: 1.5rem;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="mb-4 p-4 bg-gray-50 rounded-lg" style="background-color: #f9fafb; border-radius: 0.5rem; margin-bottom: 1rem; padding: 1rem;">
                            <h4 class="font-semibold" style="font-weight: 600; color: #111827;">${safeTitle}</h4>
                            <p class="text-sm" style="font-size: 0.875rem; color: #4b5563;">${safeAddress}</p>
                            <p class="text-sm" style="font-size: 0.875rem; color: #4b5563;">${safeDate} at ${safeTime}${safeEndTime ? ' - ' + safeEndTime : ''}</p>
                        </div>
                        <form id="bookingForm" method="POST" action="{% url 'open_house' %}">
                            {% csrf_token %}
                            <input type="hidden" name="open_house_id" value="${openHouseId}">
                            <div class="space-y-4" style="display: flex; flex-direction: column; gap: 1rem;">
                                <div>
                                    <label class="block text-sm font-medium mb-1" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Full Name *</label>
                                    <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; outline: none; transition: all 0.15s ease-in-out;">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Email Address *</label>
                                    <input type="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; outline: none; transition: all 0.15s ease-in-out;">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Phone Number *</label>
                                    <input type="tel" name="phone" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; outline: none; transition: all 0.15s ease-in-out;">
                                </div>
                            </div>
                            <div class="mt-6 flex gap-3" style="margin-top: 1.5rem; display: flex; gap: 0.75rem;">
                                <button type="button" onclick="closeBookingModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50" style="flex: 1; padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; color: #374151; background-color: white; transition: all 0.15s ease-in-out; cursor: pointer;">Cancel</button>
                                <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" style="flex: 1; padding: 0.5rem 1rem; background-color: #2563eb; color: white; border-radius: 0.375rem; border: none; transition: all 0.15s ease-in-out; cursor: pointer;">Submit Request</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        document.body.style.overflow = 'hidden';
        document.body.classList.add('modal-open');
    }

    function closeBookingModal() {
        const modal = document.getElementById('bookingModal');
        if (modal) {
            modal.remove();
            document.body.style.overflow = 'auto';
            document.body.style.paddingRight = '';
            document.body.classList.remove('modal-open');
        }
    }

    document.addEventListener('click', function(e) {
        if (e.target.id === 'bookingModal') {
            closeBookingModal();
        }
    });
</script>

<script>
    // Handle Book/Get More Info button clicks using data attributes
    document.addEventListener('DOMContentLoaded', function () {
        // Event delegation for image gallery clicks (backup to onclick handlers)
        document.addEventListener('click', function (e) {
            // Check if clicked element is an image with data-open-house-id
            const image = e.target.closest('img[data-open-house-id]');
            if (image && window.openImageGallery && typeof window.openImageGallery === 'function') {
                const openHouseId = image.getAttribute('data-open-house-id');
                if (openHouseId) {
                    e.preventDefault();
                    window.openImageGallery(parseInt(openHouseId));
                    return;
                }
            }

            // Check for gallery button
            const galleryButton = e.target.closest('[data-gallery-id]');
            if (galleryButton && window.openImageGallery && typeof window.openImageGallery === 'function') {
                const openHouseId = galleryButton.getAttribute('data-gallery-id');
                if (openHouseId) {
                    e.preventDefault();
                    e.stopPropagation();
                    window.openImageGallery(parseInt(openHouseId));
                    return;
                }
            }
        });

        // Use event delegation for book buttons
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.book-open-house-btn');
            if (btn) {
                e.preventDefault();
                const openHouseId = btn.getAttribute('data-open-house-id');
                const title = btn.getAttribute('data-title');
                const address = btn.getAttribute('data-address');
                const date = btn.getAttribute('data-date');
                const time = btn.getAttribute('data-time');
                const endTime = btn.getAttribute('data-end-time') || '';
                const price = btn.getAttribute('data-price');

                openBookingModal(openHouseId, title, address, date, time, endTime, price);
            }
        });

        // Use event delegation to handle dynamically created forms
        document.addEventListener('submit', function (e) {
            const form = e.target;

            if (form && form.action && form.action.includes('open-house')) {
                e.preventDefault();

                // Get form data
                const formData = new FormData(form);
                const name = formData.get('name');

                // Show success popup
                const message = `Thank you for your open house registration, ${name}! Our team will contact you within 24 hours to confirm your visit and provide additional details.`;
                showSuccessPopup(message);

                // Submit form after showing popup
                setTimeout(() => {
                    form.submit();
                }, 2000);
            }
        });
    });
</script>

{% include 'Raj/success_popup.html' %}

<script>
    // Handle Book/Get More Info button clicks using data attributes
    // Also add event delegation for image gallery as backup
    document.addEventListener('DOMContentLoaded', function () {
        // Event delegation for image gallery clicks (backup to onclick handlers)
        document.addEventListener('click', function (e) {
            // Check if clicked element is an image with data-open-house-id
            const image = e.target.closest('img[data-open-house-id]');
            if (image && window.openImageGallery && typeof window.openImageGallery === 'function') {
                const openHouseId = image.getAttribute('data-open-house-id');
                if (openHouseId) {
                    e.preventDefault();
                    window.openImageGallery(parseInt(openHouseId));
                    return;
                }
            }

            // Check for gallery button
            const galleryButton = e.target.closest('[data-gallery-id]');
            if (galleryButton && window.openImageGallery && typeof window.openImageGallery === 'function') {
                const openHouseId = galleryButton.getAttribute('data-gallery-id');
                if (openHouseId) {
                    e.preventDefault();
                    e.stopPropagation();
                    window.openImageGallery(parseInt(openHouseId));
                    return;
                }
            }
        });

        // Use event delegation for book buttons
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.book-open-house-btn');
            if (btn) {
                e.preventDefault();
                const openHouseId = btn.getAttribute('data-open-house-id');
                const title = btn.getAttribute('data-title');
                const address = btn.getAttribute('data-address');
                const date = btn.getAttribute('data-date');
                const time = btn.getAttribute('data-time');
                const endTime = btn.getAttribute('data-end-time') || '';
                const price = btn.getAttribute('data-price');

                openBookingModal(openHouseId, title, address, date, time, endTime, price);
            }

            // Handle View Details button
            const viewDetailsBtn = e.target.closest('.view-open-house-details-btn');
            if (viewDetailsBtn) {
                e.preventDefault();
                const openHouseId = viewDetailsBtn.getAttribute('data-open-house-id');
                const title = viewDetailsBtn.getAttribute('data-title');
                const address = viewDetailsBtn.getAttribute('data-address');
                const date = viewDetailsBtn.getAttribute('data-date');
                const time = viewDetailsBtn.getAttribute('data-time');
                const endTime = viewDetailsBtn.getAttribute('data-end-time') || '';
                const bedrooms = viewDetailsBtn.getAttribute('data-bedrooms') || '';
                const bathrooms = viewDetailsBtn.getAttribute('data-bathrooms') || '';
                const area = viewDetailsBtn.getAttribute('data-area') || '';
                const description = viewDetailsBtn.getAttribute('data-description') || '';
                const agentName = viewDetailsBtn.getAttribute('data-agent-name') || '';
                const agentLink = viewDetailsBtn.getAttribute('data-agent-link') || '';
                const agentImage = viewDetailsBtn.getAttribute('data-agent-image') || '';
                const images = viewDetailsBtn.getAttribute('data-images') || '';
                const mainImage = viewDetailsBtn.getAttribute('data-main-image') || '';

                openOpenHouseDetailsModal(openHouseId, title, address, date, time, endTime, bedrooms, bathrooms, area, description, agentName, agentLink, agentImage, images, mainImage);
            }
        });

        // Use event delegation to handle dynamically created forms
        document.addEventListener('submit', function (e) {
            const form = e.target;

            if (form && form.action && form.action.includes('open-house')) {
                e.preventDefault();

                // Get form data
                const formData = new FormData(form);
                const name = formData.get('name');

                // Show success popup
                const message = `Thank you for your open house registration, ${name}! Our team will contact you within 24 hours to confirm your visit and provide additional details.`;
                showSuccessPopup(message);

                // Submit form after showing popup
                setTimeout(() => {
                    form.submit();
                }, 2000);
            }
        });
    });
</script>

</body>
</html>

